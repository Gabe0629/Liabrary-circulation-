-- Enable foreign key enforcement
PRAGMA foreign_keys = ON;

-- ---
-- Table for Authors
-- ---
CREATE TABLE authors (
  author_id INTEGER PRIMARY KEY AUTOINCREMENT,
  author_name VARCHAR(255) NOT NULL
);

-- ---
-- Table for Books
-- ---
CREATE TABLE books (
  book_id INTEGER PRIMARY KEY AUTOINCREMENT,
  title VARCHAR(255) NOT NULL,
  isbn VARCHAR(13) UNIQUE,
  published_year INTEGER,
  CHECK (published_year IS NULL OR (published_year > 1000 AND published_year <= strftime('%Y', 'now')))
);

-- ---
-- Junction table for Books and Authors (Many-to-Many)
-- ---
CREATE TABLE book_authors (
  book_id INTEGER NOT NULL,
  author_id INTEGER NOT NULL,
  PRIMARY KEY (book_id, author_id),
  FOREIGN KEY (book_id) REFERENCES books (book_id) ON DELETE CASCADE,
  FOREIGN KEY (author_id) REFERENCES authors (author_id) ON DELETE CASCADE
);

-- ---
-- Table for Library Branches
-- ---
CREATE TABLE branches (
  branch_id INTEGER PRIMARY KEY AUTOINCREMENT,
  branch_name VARCHAR(255) NOT NULL,
  address VARCHAR(255)
);

-- ---
-- Table for Patrons (Library Members)
-- ---
CREATE TABLE patrons (
  patron_id INTEGER PRIMARY KEY AUTOINCREMENT,
  patron_name VARCHAR(255) NOT NULL,
  email VARCHAR(255) NOT NULL UNIQUE,
  join_date DATE DEFAULT (date('now'))
);

-- ---
-- Table for specific Copies of Books
-- ---
CREATE TABLE copies (
  copy_id INTEGER PRIMARY KEY AUTOINCREMENT,
  book_id INTEGER NOT NULL,
  branch_id INTEGER NOT NULL, -- Link copy to a branch
  status VARCHAR(50) NOT NULL DEFAULT 'available',
  CHECK (status IN ('available', 'loaned', 'damaged', 'lost')),
  FOREIGN KEY (book_id) REFERENCES books (book_id) ON DELETE CASCADE,
  FOREIGN KEY (branch_id) REFERENCES branches (branch_id) ON DELETE SET NULL
);

-- ---
-- Table for Loans
-- ---
CREATE TABLE loans (
  loan_id INTEGER PRIMARY KEY AUTOINCREMENT,
  copy_id INTEGER NOT NULL,
  patron_id INTEGER NOT NULL,
  loan_date DATE NOT NULL,
  due_date DATE NOT NULL,
  return_date DATE,
  CHECK (return_date IS NULL OR return_date >= loan_date),
  FOREIGN KEY (copy_id) REFERENCES copies (copy_id),
  FOREIGN KEY (patron_id) REFERENCES patrons (patron_id)
);

-- ---
-- Table for Fines
-- ---
CREATE TABLE fines (
  fine_id INTEGER PRIMARY KEY AUTOINCREMENT,
  loan_id INTEGER NOT NULL UNIQUE, -- A loan can only have one fine
  amount DECIMAL(5, 2) NOT NULL,
  status VARCHAR(50) NOT NULL DEFAULT 'unpaid',
  issue_date DATE NOT NULL,
  CHECK (amount > 0),
  CHECK (status IN ('unpaid', 'paid', 'waived')),
  FOREIGN KEY (loan_id) REFERENCES loans (loan_id)
);